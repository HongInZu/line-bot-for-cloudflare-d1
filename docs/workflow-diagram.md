# LINE 推播系統工作流程圖

本文檔提供系統的完整工作流程圖，幫助 PM 和團隊成員理解系統架構和運作方式。

## 目錄
1. [系統架構總覽](#系統架構總覽)
2. [訊息模板建立流程](#訊息模板建立流程)
3. [推播執行流程](#推播執行流程)
4. [使用者操作流程](#使用者操作流程)
5. [資料流向圖](#資料流向圖)

---

## 系統架構總覽

```
┌─────────────────────────────────────────────────────────────────┐
│                          前端 (Nuxt.js)                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │
│  │  儀表板頁面   │  │  訊息編輯器   │  │  收件人管理   │         │
│  └──────────────┘  └──────────────┘  └──────────────┘         │
│                                                                 │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │
│  │  排程管理     │  │  查詢建構器   │  │  數據分析     │         │
│  └──────────────┘  └──────────────┘  └──────────────┘         │
│                                                                 │
└────────────────────────────┬────────────────────────────────────┘
                             │
                             │ RESTful API
                             │
┌────────────────────────────┴────────────────────────────────────┐
│                  後端 (Cloudflare Workers)                       │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │
│  │  認證中介層   │  │  模板引擎     │  │  推播服務     │         │
│  └──────────────┘  └──────────────┘  └──────────────┘         │
│                                                                 │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │
│  │  排程處理     │  │  查詢執行     │  │  Webhook處理  │         │
│  └──────────────┘  └──────────────┘  └──────────────┘         │
│                                                                 │
└─────────────────┬──────────────────────┬────────────────────────┘
                  │                      │
        ┌─────────┴─────────┐   ┌───────┴────────┐
        │                   │   │                │
        ▼                   ▼   ▼                ▼
┌───────────────┐   ┌──────────────┐   ┌─────────────────┐
│ Cloudflare D1 │   │ LINE         │   │ Cloudflare Cron │
│ (資料庫)       │   │ Messaging API│   │ (排程觸發)       │
└───────────────┘   └──────────────┘   └─────────────────┘
```

---

## 訊息模板建立流程

### 完整流程圖

```
開始
 │
 ├─→ 1. 使用者進入訊息編輯器
 │
 ├─→ 2. 貼上或選擇 LINE 訊息 JSON
 │      │
 │      ├─ 選項A: 從範本庫選擇
 │      ├─ 選項B: 貼上自訂 JSON
 │      └─ 選項C: 從 LINE Flex Simulator 匯入
 │
 ├─→ 3. 系統自動解析變數
 │      │
 │      └─ 偵測所有 {{變數}} 語法
 │         範例: {{user.name}}, {{order.id}}, {{items}}
 │
 ├─→ 4. 使用者設定變數資料來源
 │      │
 │      ├─ 變數 1: user.name
 │      │   └─ 資料來源: 收件人屬性 → displayName
 │      │
 │      ├─ 變數 2: order.id
 │      │   └─ 資料來源: SQL 查詢
 │      │      SELECT order_id, order_status, total_amount
 │      │      FROM orders
 │      │      WHERE user_id = {{recipient.lineUserId}}
 │      │      └─ 欄位映射: order_id → order.id
 │      │
 │      └─ 變數 3: items
 │          └─ 資料來源: SQL 查詢（陣列）
 │             SELECT name, price, quantity
 │             FROM order_items
 │             WHERE order_id = {{order.id}}
 │
 ├─→ 5. 即時預覽
 │      │
 │      ├─ 左側: JSON 編輯器
 │      │   └─ 顯示原始 JSON（含變數語法）
 │      │
 │      ├─ 中間: 變數設定面板
 │      │   └─ 列出所有變數及其資料來源
 │      │
 │      └─ 右側: 視覺化預覽
 │          ├─ LINE 聊天室模擬器
 │          ├─ Flex Message 渲染
 │          └─ 填入測試資料後的效果
 │
 ├─→ 6. 驗證與測試
 │      │
 │      ├─ JSON 格式驗證 ✓
 │      ├─ 變數完整性檢查 ✓
 │      ├─ SQL 查詢測試 ✓
 │      └─ 發送測試訊息到指定 LINE ID
 │
 ├─→ 7. 儲存為訊息模板
 │      │
 │      └─ 儲存內容:
 │         ├─ 模板名稱
 │         ├─ 訊息 JSON
 │         ├─ 變數配置
 │         ├─ 資料來源設定
 │         └─ 分類/標籤
 │
 └─→ 完成
```

### 畫面示意圖

```
┌────────────────────────────────────────────────────────────────────────┐
│ 訊息模板編輯器                                         [儲存] [測試推播]  │
├──────────────────┬─────────────────┬───────────────────────────────────┤
│                  │                 │                                   │
│  JSON 編輯器      │   變數設定       │      即時預覽                      │
│                  │                 │                                   │
│ {                │ 📋 變數列表 (3)  │  📱 LINE 聊天室模擬                │
│   "type": "flex",│                 │  ┌─────────────────────────┐     │
│   "contents": {  │ • user.name     │  │      ⬅ 返回    預覽      │     │
│     "body": {    │   來源: 收件人   │  ├─────────────────────────┤     │
│       "contents":│   值: 張三       │  │                         │     │
│       [          │   ✓             │  │  ┌──────────────────┐   │     │
│         {        │                 │  │  │ 您好，張三！      │   │     │
│   "type": "text",│ • order.id      │  │  │                  │   │     │
│   "text":        │   來源: SQL查詢  │  │  │ 訂單編號: 12345   │   │     │
│   "您好，         │   查詢: orders   │  │  │ 狀態: 已出貨      │   │     │
│   {{user.name}}!"│   值: 12345     │  │  │                  │   │     │
│         },       │   ✓             │  │  │ 商品明細:         │   │     │
│         {        │                 │  │  │ • 商品A  $100    │   │     │
│   "type": "text",│ • items         │  │  │ • 商品B  $200    │   │     │
│   "text":        │   來源: SQL查詢  │  │  │                  │   │     │
│   "訂單編號:      │   查詢: order_it │  │  │ 總計: $300       │   │     │
│   {{order.id}}"  │   值: [2筆]     │  │  └──────────────────┘   │     │
│         }        │   ✓             │  │                         │     │
│       ]          │                 │  │                         │     │
│     }            │ [+ 新增變數]     │  └─────────────────────────┘     │
│   }              │                 │                                   │
│ }                │ [批次填入測試]   │  [切換主題] [JSON檢視]             │
│                  │                 │                                   │
│ [格式化] [驗證]   │                 │  ⚠ 警告: 變數 user.email 未設定   │
│ [範本庫] [匯入]   │                 │                                   │
│                  │                 │                                   │
└──────────────────┴─────────────────┴───────────────────────────────────┘
```

---

## 推播執行流程

### 立即推播流程

```
使用者點擊「立即推播」
 │
 ├─→ 1. 選擇訊息模板
 │      └─ 從模板列表選擇已建立的模板
 │
 ├─→ 2. 選擇收件人
 │      │
 │      ├─ 選項A: 全部收件人
 │      ├─ 選項B: 特定群組
 │      ├─ 選項C: 特定標籤
 │      └─ 選項D: 手動選擇個別收件人
 │
 ├─→ 3. 預覽和確認
 │      └─ 顯示將發送的訊息和收件人數量
 │
 ├─→ 4. 確認推播
 │      └─ 前端發送請求到後端 API
 │
 ├─→ 5. 後端處理 (Cloudflare Workers)
 │      │
 │      ├─ 5.1 驗證使用者權限
 │      │
 │      ├─ 5.2 取得收件人列表
 │      │      └─ 從 D1 資料庫查詢
 │      │
 │      ├─ 5.3 逐個收件人處理
 │      │      │
 │      │      └─ 針對每個收件人:
 │      │          │
 │      │          ├─ 取得收件人資料
 │      │          │
 │      │          ├─ 執行關聯的 SQL 查詢
 │      │          │   └─ 將收件人資訊作為參數
 │      │          │      範例: WHERE user_id = {{recipient.lineUserId}}
 │      │          │
 │      │          ├─ 組合所有資料
 │      │          │   ├─ 收件人屬性
 │      │          │   └─ SQL 查詢結果
 │      │          │
 │      │          ├─ 模板引擎渲染
 │      │          │   ├─ 變數替換
 │      │          │   ├─ 條件判斷 {{#if}}
 │      │          │   └─ 迴圈展開 {{#each}}
 │      │          │
 │      │          └─ 生成最終 JSON
 │      │
 │      ├─ 5.4 呼叫 LINE Messaging API
 │      │      │
 │      │      └─ 發送訊息給每個收件人
 │      │         POST https://api.line.me/v2/bot/message/push
 │      │
 │      └─ 5.5 記錄推播結果
 │             └─ 儲存到 D1 資料庫
 │                ├─ 推播ID
 │                ├─ 收件人ID
 │                ├─ 狀態 (成功/失敗)
 │                ├─ 時間戳記
 │                └─ 錯誤訊息 (如有)
 │
 ├─→ 6. 回傳結果給前端
 │      │
 │      └─ 顯示推播統計:
 │         ├─ 總收件人數: 100
 │         ├─ 成功: 98
 │         ├─ 失敗: 2
 │         └─ 執行時間: 5.2 秒
 │
 └─→ 完成
```

### 排程推播流程

```
使用者建立排程推播
 │
 ├─→ 1. 設定排程規則
 │      │
 │      ├─ 選擇訊息模板
 │      ├─ 選擇收件人
 │      ├─ 設定發送時間
 │      │   ├─ 單次: 2024-12-25 09:00
 │      │   └─ 重複: 每週一 10:00
 │      └─ 設定結束條件
 │
 ├─→ 2. 儲存排程到資料庫
 │
 ├─→ 3. Cloudflare Cron 觸發 (每5分鐘)
 │      │
 │      └─ 定期執行: */5 * * * *
 │
 ├─→ 4. 檢查待執行排程
 │      │
 │      └─ SELECT * FROM schedules
 │         WHERE status = 'active'
 │         AND next_execution_at <= NOW()
 │
 ├─→ 5. 執行排程推播
 │      │
 │      └─ 同「立即推播流程」步驟 5
 │
 ├─→ 6. 更新排程狀態
 │      │
 │      ├─ 記錄執行歷史
 │      ├─ 計算下次執行時間
 │      └─ 檢查是否結束
 │         ├─ 達到執行次數 → 標記為完成
 │         └─ 繼續執行 → 更新 next_execution_at
 │
 └─→ 完成
```

---

## 使用者操作流程

### 場景 1: 建立訂單通知模板

```
┌─────────────────────────────────────────────────────────────┐
│ 使用者: 行銷人員 Alice                                       │
│ 目標: 當使用者下單後，自動發送訂單確認訊息                    │
└─────────────────────────────────────────────────────────────┘

步驟 1: 準備 Flex Message JSON
  └─ 從 LINE Flex Simulator 設計訊息
     └─ 包含: 訂單編號、商品清單、總金額

步驟 2: 貼上 JSON 到編輯器
  └─ 將設計好的 JSON 貼入系統

步驟 3: 替換為變數語法
  └─ 將固定值改為變數
     原本: "訂單編號: 12345"
     改為: "訂單編號: {{order.id}}"

步驟 4: 設定資料來源
  ├─ user.name → 收件人.displayName
  ├─ order.id, order.total → SQL 查詢
  │  SELECT id, total_amount, status
  │  FROM orders
  │  WHERE user_id = {{recipient.lineUserId}}
  │  ORDER BY created_at DESC
  │  LIMIT 1
  │
  └─ items → SQL 查詢（陣列）
     SELECT product_name, quantity, price
     FROM order_items
     WHERE order_id = {{order.id}}

步驟 5: 測試預覽
  ├─ 輸入測試資料
  └─ 查看渲染結果

步驟 6: 儲存模板
  └─ 命名: "訂單確認通知"
     分類: "交易通知"

步驟 7: 整合到推播流程
  ├─ 選項A: 在應用程式下單後，呼叫推播 API
  └─ 選項B: 設定自動化規則（當訂單狀態改變時觸發）
```

### 場景 2: 發送每週促銷訊息

```
┌─────────────────────────────────────────────────────────────┐
│ 使用者: 行銷人員 Bob                                         │
│ 目標: 每週一早上 10:00 發送本週促銷商品                       │
└─────────────────────────────────────────────────────────────┘

步驟 1: 建立促銷商品模板
  └─ 使用 {{#each}} 迴圈顯示商品列表

步驟 2: 設定 SQL 查詢
  SELECT name, price, discount_price, image_url
  FROM products
  WHERE is_promotion = true
  AND promotion_start <= NOW()
  AND promotion_end >= NOW()
  LIMIT 5

步驟 3: 選擇收件人群組
  └─ 群組: "促銷通知訂閱者"
     └─ 包含 5,000 位使用者

步驟 4: 建立排程
  ├─ 發送時間: 每週一 10:00
  ├─ 時區: Asia/Taipei
  └─ 結束條件: 永久重複

步驟 5: 系統自動執行
  └─ 每週一 10:00，系統會:
     ├─ 查詢最新促銷商品
     ├─ 生成訊息內容
     └─ 發送給所有訂閱者
```

---

## 資料流向圖

### 模板渲染資料流

```
┌─────────────────────────────────────────────────────────────────┐
│                     資料來源                                     │
├────────────────┬────────────────────┬───────────────────────────┤
│                │                    │                           │
│  收件人資料     │   D1 資料庫查詢     │   手動輸入（測試用）       │
│                │                    │                           │
│  • lineUserId  │   • orders         │   • 範例資料              │
│  • displayName │   • products       │   • 預設值                │
│  • groups      │   • user_profiles  │                           │
│  • tags        │   • ...            │                           │
│                │                    │                           │
└────────┬───────┴──────────┬─────────┴──────────┬────────────────┘
         │                  │                    │
         └──────────────────┼────────────────────┘
                            │
                            ▼
         ┌──────────────────────────────────────┐
         │        資料合併 & 映射               │
         │                                      │
         │  {                                   │
         │    recipient: { ... },               │
         │    order: { ... },                   │
         │    items: [ ... ]                    │
         │  }                                   │
         └──────────────────┬───────────────────┘
                            │
                            ▼
         ┌──────────────────────────────────────┐
         │          模板引擎處理                │
         │                                      │
         │  1. 變數替換                         │
         │     {{user.name}} → "張三"           │
         │                                      │
         │  2. 條件判斷                         │
         │     {{#if order.status == 'shipped'}}│
         │                                      │
         │  3. 迴圈處理                         │
         │     {{#each items}} ... {{/each}}    │
         │                                      │
         └──────────────────┬───────────────────┘
                            │
                            ▼
         ┌──────────────────────────────────────┐
         │         最終 JSON 訊息               │
         │                                      │
         │  {                                   │
         │    "type": "flex",                   │
         │    "contents": {                     │
         │      "body": {                       │
         │        "contents": [                 │
         │          { "text": "您好，張三！" }   │
         │        ]                             │
         │      }                               │
         │    }                                 │
         │  }                                   │
         └──────────────────┬───────────────────┘
                            │
                            ▼
         ┌──────────────────────────────────────┐
         │      LINE Messaging API              │
         │                                      │
         │  POST /v2/bot/message/push           │
         │  {                                   │
         │    "to": "U1234567890abcdef...",     │
         │    "messages": [ ... ]               │
         │  }                                   │
         └──────────────────────────────────────┘
```

### 系統整體資料流

```
┌──────────────┐
│   使用者      │
└──────┬───────┘
       │
       │ 1. 編輯模板
       ▼
┌──────────────────────┐
│   訊息編輯器 (前端)   │
│   - JSON 編輯        │
│   - 變數設定         │
│   - 即時預覽         │
└──────┬───────────────┘
       │
       │ 2. 儲存模板
       ▼
┌──────────────────────┐
│   後端 API           │
│   POST /api/templates│
└──────┬───────────────┘
       │
       │ 3. 寫入資料庫
       ▼
┌──────────────────────┐
│   Cloudflare D1      │
│   - message_templates│
│   - variable_configs │
└──────────────────────┘
       │
       │ 4. 推播觸發
       ▼
┌──────────────────────┐
│   推播服務 (後端)     │
│   - 取得模板         │
│   - 查詢資料         │
│   - 渲染訊息         │
└──────┬───────────────┘
       │
       │ 5. 發送訊息
       ▼
┌──────────────────────┐
│   LINE API           │
└──────┬───────────────┘
       │
       │ 6. 送達
       ▼
┌──────────────────────┐
│   LINE 使用者         │
└──────────────────────┘
```

---

## 時序圖

### 訊息推播完整時序

```
使用者      前端         後端          D1         LINE API     收件人
  │          │           │            │             │           │
  ├─ 點擊推播 ─>│           │            │             │           │
  │          │           │            │             │           │
  │          ├─ POST /broadcasts      │             │           │
  │          │────────>  │            │             │           │
  │          │           │            │             │           │
  │          │           ├─ 查詢模板   │             │           │
  │          │           │─────────>  │             │           │
  │          │           │<───────────│             │           │
  │          │           │            │             │           │
  │          │           ├─ 查詢收件人 │             │           │
  │          │           │─────────>  │             │           │
  │          │           │<───────────│             │           │
  │          │           │            │             │           │
  │          │           │ 逐個處理    │             │           │
  │          │           │            │             │           │
  │          │           ├─ 查詢資料   │             │           │
  │          │           │─────────>  │             │           │
  │          │           │<───────────│             │           │
  │          │           │            │             │           │
  │          │           ├─ 模板渲染   │             │           │
  │          │           │ (內部處理)  │             │           │
  │          │           │            │             │           │
  │          │           ├─ 推送訊息  ──────────────>│           │
  │          │           │            │             │           │
  │          │           │            │             ├─ 送達 ───>│
  │          │           │            │             │           │
  │          │           ├─ 記錄結果   │             │           │
  │          │           │─────────>  │             │           │
  │          │           │            │             │           │
  │          │<─ 回傳統計 ──────────│            │             │           │
  │          │           │            │             │           │
  │<─ 顯示結果 ──│           │            │             │           │
  │          │           │            │             │           │
```

---

## 技術架構圖

```
┌─────────────────────────────────────────────────────────────────┐
│                     瀏覽器 (Browser)                             │
│                                                                 │
│  ┌────────────────────────────────────────────────────────┐    │
│  │               Nuxt.js 應用程式                          │    │
│  │                                                        │    │
│  │  ┌──────────────┐  ┌──────────────┐  ┌─────────────┐ │    │
│  │  │   Pages      │  │  Components  │  │   Stores    │ │    │
│  │  │  - /editor   │  │  - JsonEditor│  │   (Pinia)   │ │    │
│  │  │  - /dashboard│  │  - Preview   │  │             │ │    │
│  │  │  - /schedules│  │  - QueryUI   │  │             │ │    │
│  │  └──────────────┘  └──────────────┘  └─────────────┘ │    │
│  │                                                        │    │
│  │  ┌────────────────────────────────────────────────┐   │    │
│  │  │           Composables & Utils                  │   │    │
│  │  │  - useAuth, useApi, useTemplate                │   │    │
│  │  └────────────────────────────────────────────────┘   │    │
│  └────────────────────────────────────────────────────────┘    │
│                                                                 │
└───────────────────────────┬─────────────────────────────────────┘
                            │
                            │ HTTPS
                            │
┌───────────────────────────┴─────────────────────────────────────┐
│              Cloudflare Workers (Edge Runtime)                  │
│                                                                 │
│  ┌────────────────────────────────────────────────────────┐    │
│  │                    Hono Framework                      │    │
│  │                                                        │    │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌───────┐ │    │
│  │  │  Routes  │  │  Services│  │Middleware│  │ Utils │ │    │
│  │  │          │  │          │  │          │  │       │ │    │
│  │  │ /auth    │  │ Template │  │   JWT    │  │Template│ │    │
│  │  │ /api/*   │  │ Engine   │  │   CORS   │  │Engine  │ │    │
│  │  │ /webhook │  │ Broadcast│  │   Auth   │  │Query   │ │    │
│  │  └──────────┘  └──────────┘  └──────────┘  └───────┘ │    │
│  └────────────────────────────────────────────────────────┘    │
│                                                                 │
│  ┌────────────────────────────────────────────────────────┐    │
│  │              Cron Triggers (排程)                      │    │
│  │              */5 * * * * (每5分鐘)                      │    │
│  └────────────────────────────────────────────────────────┘    │
│                                                                 │
└──────────┬─────────────────────────┬──────────────────────┬─────┘
           │                         │                      │
           ▼                         ▼                      ▼
┌─────────────────┐      ┌─────────────────┐    ┌──────────────────┐
│ Cloudflare D1   │      │  LINE           │    │ Cloudflare KV    │
│ (SQLite)        │      │  Messaging API  │    │ (Key-Value)      │
│                 │      │                 │    │                  │
│ - users         │      │ - Push Message  │    │ - Session Cache  │
│ - templates     │      │ - Multicast     │    │ - Rate Limiting  │
│ - broadcasts    │      │ - Reply         │    │                  │
│ - recipients    │      │                 │    │                  │
│ - schedules     │      │                 │    │                  │
└─────────────────┘      └─────────────────┘    └──────────────────┘
```

---

## 總結

### 系統核心特色

1. **前後端分離**
   - 前端: Nuxt.js + Vue 3
   - 後端: Cloudflare Workers + Hono
   - 資料庫: Cloudflare D1

2. **模板系統創新**
   - JSON 貼上即用
   - 自動變數解析
   - 視覺化預覽
   - 多資料來源整合

3. **推播彈性**
   - 立即推播
   - 排程推播
   - 精準收件人選擇

4. **開發者友善**
   - RESTful API
   - TypeScript 全棧
   - 完整文檔

### 下一步

1. 參考 [Stories README](stories/README.md) 了解完整開發規劃
2. 查看個別 Story 文檔了解詳細實作細節
3. 按照四個階段循序開發

---

*最後更新: 2024-01-15*
