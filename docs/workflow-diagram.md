# LINE 推播系統工作流程圖

本文檔提供系統的完整工作流程圖，幫助 PM 和團隊成員理解系統架構和運作方式。

---

## ⚠️ 重要說明

### 系統定位

**本系統是「訊息模板管理與推播系統」，而非視覺化訊息設計工具。**

#### 我們提供：
- ✅ **JSON 輸入區**：讓使用者貼上已設計好的 LINE 訊息 JSON
- ✅ **變數系統**：自動解析 `{{變數}}` 並設定資料來源（SQL/收件人/手動）
- ✅ **即時預覽**：模擬填入資料後，訊息在 LINE 中的實際外觀
- ✅ **推播管理**：排程推播、收件人管理、推播統計

#### 我們不提供：
- ❌ **拖拉式視覺編輯器**（如 LINE Flex Message Simulator 的介面）
- ❌ **所見即所得的訊息設計工具**
- ❌ **元件庫或模板設計功能**

#### 典型工作流程：
```
1. 使用者在 LINE Flex Simulator 設計訊息外觀
   └─ 調整版面、顏色、按鈕等視覺元素
   └─ 導出 JSON

2. 將 JSON 貼入本系統
   └─ 將固定值替換為變數（例如 {{user.name}}）

3. 設定變數的資料來源
   └─ 從資料庫查詢、收件人資訊等

4. 預覽效果並儲存模板

5. 設定推播規則並執行
```

---

## 目錄
1. [⚠️ 安全性警告](#安全性警告)
2. [系統架構總覽](#系統架構總覽)
3. [訊息模板建立流程](#訊息模板建立流程)
4. [推播執行流程](#推播執行流程)
5. [使用者操作流程](#使用者操作流程)
6. [資料流向圖](#資料流向圖)
7. [安全機制說明](#安全機制說明)

---

## ⚠️ 安全性警告

### 為什麼安全性是最高優先級？

本系統的核心功能之一是**讓使用者透過查詢建構器存取自己的 Cloudflare D1 資料庫**。

這意味著：
1. **使用者可以執行 SQL 查詢** → 必須防止 SQL 注入
2. **系統會存取客戶的生產資料** → 必須確保資料隔離
3. **多個客戶共用同一個 Worker** → 必須防止跨租戶存取
4. **查詢結果會被推播到 LINE** → 必須保護敏感資料

### 關鍵安全措施（必須實作）

```
┌─────────────────────────────────────────────────────────────┐
│                      安全防護層                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  1. SQL 查詢驗證器                                          │
│     ✓ 只允許 SELECT 查詢                                    │
│     ✓ 阻擋 DROP, DELETE, UPDATE, INSERT 等危險指令          │
│     ✓ 禁止存取系統表（sqlite_master 等）                    │
│     ✓ 強制使用 LIMIT（最大 10,000 筆）                      │
│                                                             │
│  2. 租戶隔離                                                │
│     ✓ 每個使用者只能存取自己的資料                          │
│     ✓ 所有查詢自動加上 tenant_id 過濾                       │
│     ✓ 使用 Row-Level Security                              │
│                                                             │
│  3. 參數化查詢                                              │
│     ✓ 使用 Prepared Statements                             │
│     ✓ 絕不使用字串拼接                                      │
│     ✓ 變數值透過 bind() 傳入                                │
│                                                             │
│  4. 權限控制                                                │
│     ✓ JWT 驗證                                              │
│     ✓ 角色權限檢查（Admin/Editor/Viewer）                   │
│     ✓ API rate limiting                                     │
│                                                             │
│  5. 唯讀連線                                                │
│     ✓ 查詢建構器使用唯讀資料庫連線                          │
│     ✓ 即使 SQL 驗證被繞過，也無法修改資料                   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 攻擊場景範例

#### 場景 1: SQL 注入嘗試
```
使用者輸入惡意變數值:
user.name = "'; DROP TABLE users; --"

❌ 沒有防護:
SELECT * FROM orders WHERE user_name = ''; DROP TABLE users; --'

✅ 有防護:
1. 參數化查詢 → 變數值被當作字串，不會執行
2. SQL 驗證器 → 偵測到 DROP 關鍵字，拒絕執行
3. 唯讀連線 → 即使執行也無權限修改
```

#### 場景 2: 跨租戶存取嘗試
```
使用者 A (tenant_id = '123') 嘗試存取使用者 B 的資料:

❌ 沒有防護:
SELECT * FROM orders WHERE tenant_id = '456'  -- 使用者 B 的資料

✅ 有防護:
系統自動改寫查詢:
SELECT * FROM orders WHERE tenant_id = '123' AND tenant_id = '456'
→ 永遠回傳空結果
```

#### 場景 3: 系統表探測
```
使用者嘗試查看資料庫結構:

❌ 沒有防護:
SELECT * FROM sqlite_master  -- 可看到所有表結構

✅ 有防護:
SQL 驗證器檢查表名，拒絕存取系統表
```

**請務必詳閱 [Story 10: 安全性與權限控制](stories/10-security-permissions.md) 了解完整實作細節。**

---

## 系統架構總覽

```
┌─────────────────────────────────────────────────────────────────┐
│                          前端 (Nuxt.js)                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │
│  │  儀表板頁面   │  │  訊息模板管理 │  │  收件人管理   │         │
│  └──────────────┘  └──────────────┘  └──────────────┘         │
│                                                                 │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │
│  │  排程管理     │  │  查詢建構器   │  │  數據分析     │         │
│  └──────────────┘  └──────────────┘  └──────────────┘         │
│                                                                 │
└────────────────────────────┬────────────────────────────────────┘
                             │
                             │ RESTful API
                             │
┌────────────────────────────┴────────────────────────────────────┐
│                  後端 (Cloudflare Workers)                       │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  🔒 安全防護層 (Story 10)                                │  │
│  │  • JWT 驗證  • 權限檢查  • Rate Limiting                 │  │
│  │  • SQL 注入防護  • 租戶隔離                              │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │
│  │  認證中介層   │  │  模板引擎     │  │  推播服務     │         │
│  └──────────────┘  └──────────────┘  └──────────────┘         │
│                                                                 │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │
│  │  排程處理     │  │🔒查詢執行     │  │  Webhook處理  │         │
│  │              │  │(SQL驗證器)    │  │              │         │
│  └──────────────┘  └──────────────┘  └──────────────┘         │
│                                                                 │
└─────────────────┬──────────────────────┬────────────────────────┘
                  │                      │
        ┌─────────┴─────────┐   ┌───────┴────────┐
        │                   │   │                │
        ▼                   ▼   ▼                ▼
┌───────────────┐   ┌──────────────┐   ┌─────────────────┐
│ Cloudflare D1 │   │ LINE         │   │ Cloudflare Cron │
│ (資料庫)       │   │ Messaging API│   │ (排程觸發)       │
└───────────────┘   └──────────────┘   └─────────────────┘
```

---

## 訊息模板建立流程

### 完整流程圖

```
開始
 │
 ├─→ 1. 使用者進入訊息模板管理頁面
 │
 ├─→ 2. 準備 LINE 訊息 JSON（含變數）
 │      │
 │      ├─ 選項A: 從範本庫選擇
 │      ├─ 選項B: 貼上自訂 JSON
 │      └─ 選項C: 從 LINE Flex Simulator 匯入
 │
 ├─→ 3. 系統自動解析變數
 │      │
 │      └─ 偵測所有 {{變數}} 語法
 │         範例: {{user.name}}, {{order.id}}, {{items}}
 │
 ├─→ 4. 使用者設定變數資料來源
 │      │
 │      ├─ 變數 1: user.name
 │      │   └─ 資料來源: 收件人屬性 → displayName
 │      │
 │      ├─ 變數 2: order.id
 │      │   └─ 資料來源: SQL 查詢
 │      │      SELECT order_id, order_status, total_amount
 │      │      FROM orders
 │      │      WHERE user_id = {{recipient.lineUserId}}
 │      │      └─ 欄位映射: order_id → order.id
 │      │
 │      └─ 變數 3: items
 │          └─ 資料來源: SQL 查詢（陣列）
 │             SELECT name, price, quantity
 │             FROM order_items
 │             WHERE order_id = {{order.id}}
 │
 ├─→ 5. 即時預覽與測試
 │      │
 │      ├─ 左側: JSON 輸入區
 │      │   └─ 貼上 JSON（含變數語法）
 │      │   └─ 語法高亮顯示
 │      │
 │      ├─ 中間: 變數設定面板
 │      │   └─ 列出所有變數及其資料來源
 │      │
 │      └─ 右側: 訊息預覽
 │          ├─ LINE 聊天室模擬
 │          ├─ Flex Message 視覺化呈現
 │          └─ 填入測試資料後的效果
 │
 ├─→ 6. 驗證與測試
 │      │
 │      ├─ JSON 格式驗證 ✓
 │      ├─ 變數完整性檢查 ✓
 │      ├─ SQL 查詢測試 ✓
 │      └─ 發送測試訊息到指定 LINE ID
 │
 ├─→ 7. 儲存為訊息模板
 │      │
 │      └─ 儲存內容:
 │         ├─ 模板名稱
 │         ├─ 訊息 JSON
 │         ├─ 變數配置
 │         ├─ 資料來源設定
 │         └─ 分類/標籤
 │
 └─→ 完成
```

### 畫面示意圖

```
┌────────────────────────────────────────────────────────────────────────┐
│ 訊息模板設定                                           [儲存] [測試推播]  │
├──────────────────┬─────────────────┬───────────────────────────────────┤
│                  │                 │                                   │
│  JSON 輸入區      │   變數設定       │      訊息預覽                      │
│                  │                 │                                   │
│ {                │ 📋 變數列表 (3)  │  📱 LINE 聊天室模擬                │
│   "type": "flex",│                 │  ┌─────────────────────────┐     │
│   "contents": {  │ • user.name     │  │      ⬅ 返回    預覽      │     │
│     "body": {    │   來源: 收件人   │  ├─────────────────────────┤     │
│       "contents":│   值: 張三       │  │                         │     │
│       [          │   ✓             │  │  ┌──────────────────┐   │     │
│         {        │                 │  │  │ 您好，張三！      │   │     │
│   "type": "text",│ • order.id      │  │  │                  │   │     │
│   "text":        │   來源: SQL查詢  │  │  │ 訂單編號: 12345   │   │     │
│   "您好，         │   查詢: orders   │  │  │ 狀態: 已出貨      │   │     │
│   {{user.name}}!"│   值: 12345     │  │  │                  │   │     │
│         },       │   ✓             │  │  │ 商品明細:         │   │     │
│         {        │                 │  │  │ • 商品A  $100    │   │     │
│   "type": "text",│ • items         │  │  │ • 商品B  $200    │   │     │
│   "text":        │   來源: SQL查詢  │  │  │                  │   │     │
│   "訂單編號:      │   查詢: order_it │  │  │ 總計: $300       │   │     │
│   {{order.id}}"  │   值: [2筆]     │  │  └──────────────────┘   │     │
│         }        │   ✓             │  │                         │     │
│       ]          │                 │  │                         │     │
│     }            │ [+ 新增變數]     │  └─────────────────────────┘     │
│   }              │                 │                                   │
│ }                │ [批次填入測試]   │  [切換主題] [JSON檢視]             │
│                  │                 │                                   │
│ [格式化] [驗證]   │                 │  ⚠ 警告: 變數 user.email 未設定   │
│ [範本庫] [匯入]   │                 │                                   │
│                  │                 │                                   │
└──────────────────┴─────────────────┴───────────────────────────────────┘
```

---

## 推播執行流程

### 立即推播流程

```
使用者點擊「立即推播」
 │
 ├─→ 1. 選擇訊息模板
 │      └─ 從模板列表選擇已建立的模板
 │
 ├─→ 2. 選擇收件人
 │      │
 │      ├─ 選項A: 全部收件人
 │      ├─ 選項B: 特定群組
 │      ├─ 選項C: 特定標籤
 │      └─ 選項D: 手動選擇個別收件人
 │
 ├─→ 3. 預覽和確認
 │      └─ 顯示將發送的訊息和收件人數量
 │
 ├─→ 4. 確認推播
 │      └─ 前端發送請求到後端 API
 │
 ├─→ 5. 後端處理 (Cloudflare Workers)
 │      │
 │      ├─ 5.1 驗證使用者權限
 │      │
 │      ├─ 5.2 取得收件人列表
 │      │      └─ 從 D1 資料庫查詢
 │      │
 │      ├─ 5.3 逐個收件人處理
 │      │      │
 │      │      └─ 針對每個收件人:
 │      │          │
 │      │          ├─ 取得收件人資料
 │      │          │
 │      │          ├─ 執行關聯的 SQL 查詢
 │      │          │   └─ 將收件人資訊作為參數
 │      │          │      範例: WHERE user_id = {{recipient.lineUserId}}
 │      │          │
 │      │          ├─ 組合所有資料
 │      │          │   ├─ 收件人屬性
 │      │          │   └─ SQL 查詢結果
 │      │          │
 │      │          ├─ 模板引擎渲染
 │      │          │   ├─ 變數替換
 │      │          │   ├─ 條件判斷 {{#if}}
 │      │          │   └─ 迴圈展開 {{#each}}
 │      │          │
 │      │          └─ 生成最終 JSON
 │      │
 │      ├─ 5.4 呼叫 LINE Messaging API
 │      │      │
 │      │      └─ 發送訊息給每個收件人
 │      │         POST https://api.line.me/v2/bot/message/push
 │      │
 │      └─ 5.5 記錄推播結果
 │             └─ 儲存到 D1 資料庫
 │                ├─ 推播ID
 │                ├─ 收件人ID
 │                ├─ 狀態 (成功/失敗)
 │                ├─ 時間戳記
 │                └─ 錯誤訊息 (如有)
 │
 ├─→ 6. 回傳結果給前端
 │      │
 │      └─ 顯示推播統計:
 │         ├─ 總收件人數: 100
 │         ├─ 成功: 98
 │         ├─ 失敗: 2
 │         └─ 執行時間: 5.2 秒
 │
 └─→ 完成
```

### 排程推播流程

```
使用者建立排程推播
 │
 ├─→ 1. 設定排程規則
 │      │
 │      ├─ 選擇訊息模板
 │      ├─ 選擇收件人
 │      ├─ 設定發送時間
 │      │   ├─ 單次: 2024-12-25 09:00
 │      │   └─ 重複: 每週一 10:00
 │      └─ 設定結束條件
 │
 ├─→ 2. 儲存排程到資料庫
 │
 ├─→ 3. Cloudflare Cron 觸發 (每5分鐘)
 │      │
 │      └─ 定期執行: */5 * * * *
 │
 ├─→ 4. 檢查待執行排程
 │      │
 │      └─ SELECT * FROM schedules
 │         WHERE status = 'active'
 │         AND next_execution_at <= NOW()
 │
 ├─→ 5. 執行排程推播
 │      │
 │      └─ 同「立即推播流程」步驟 5
 │
 ├─→ 6. 更新排程狀態
 │      │
 │      ├─ 記錄執行歷史
 │      ├─ 計算下次執行時間
 │      └─ 檢查是否結束
 │         ├─ 達到執行次數 → 標記為完成
 │         └─ 繼續執行 → 更新 next_execution_at
 │
 └─→ 完成
```

---

## 使用者操作流程

### 場景 1: 建立訂單通知模板

```
┌─────────────────────────────────────────────────────────────┐
│ 使用者: 行銷人員 Alice                                       │
│ 目標: 當使用者下單後，自動發送訂單確認訊息                    │
│                                                             │
│ 重點: 系統不提供視覺化設計工具                               │
│       需先在 LINE Flex Simulator 設計好訊息外觀             │
│       然後將 JSON 貼入系統，設定變數和資料來源               │
└─────────────────────────────────────────────────────────────┘

步驟 1: 在 LINE Flex Simulator 設計訊息外觀
  └─ 設計包含: 訂單編號、商品清單、總金額的訊息樣式
     └─ 導出 JSON

步驟 2: 貼上 JSON 到系統
  └─ 將設計好的 JSON 貼入「JSON 輸入區」

步驟 3: 替換為變數語法
  └─ 將固定值改為變數
     原本: "訂單編號: 12345"
     改為: "訂單編號: {{order.id}}"

步驟 4: 設定資料來源
  ├─ user.name → 收件人.displayName
  ├─ order.id, order.total → SQL 查詢
  │  SELECT id, total_amount, status
  │  FROM orders
  │  WHERE user_id = {{recipient.lineUserId}}
  │  ORDER BY created_at DESC
  │  LIMIT 1
  │
  └─ items → SQL 查詢（陣列）
     SELECT product_name, quantity, price
     FROM order_items
     WHERE order_id = {{order.id}}

步驟 5: 測試預覽
  ├─ 輸入測試資料
  └─ 查看渲染結果

步驟 6: 儲存模板
  └─ 命名: "訂單確認通知"
     分類: "交易通知"

步驟 7: 整合到推播流程
  ├─ 選項A: 在應用程式下單後，呼叫推播 API
  └─ 選項B: 設定自動化規則（當訂單狀態改變時觸發）
```

### 場景 2: 發送每週促銷訊息

```
┌─────────────────────────────────────────────────────────────┐
│ 使用者: 行銷人員 Bob                                         │
│ 目標: 每週一早上 10:00 發送本週促銷商品                       │
└─────────────────────────────────────────────────────────────┘

步驟 1: 建立促銷商品模板
  └─ 使用 {{#each}} 迴圈顯示商品列表

步驟 2: 設定 SQL 查詢
  SELECT name, price, discount_price, image_url
  FROM products
  WHERE is_promotion = true
  AND promotion_start <= NOW()
  AND promotion_end >= NOW()
  LIMIT 5

步驟 3: 選擇收件人群組
  └─ 群組: "促銷通知訂閱者"
     └─ 包含 5,000 位使用者

步驟 4: 建立排程
  ├─ 發送時間: 每週一 10:00
  ├─ 時區: Asia/Taipei
  └─ 結束條件: 永久重複

步驟 5: 系統自動執行
  └─ 每週一 10:00，系統會:
     ├─ 查詢最新促銷商品
     ├─ 生成訊息內容
     └─ 發送給所有訂閱者
```

---

## 資料流向圖

### 模板渲染資料流

```
┌─────────────────────────────────────────────────────────────────┐
│                     資料來源                                     │
├────────────────┬────────────────────┬───────────────────────────┤
│                │                    │                           │
│  收件人資料     │   D1 資料庫查詢     │   手動輸入（測試用）       │
│                │                    │                           │
│  • lineUserId  │   • orders         │   • 範例資料              │
│  • displayName │   • products       │   • 預設值                │
│  • groups      │   • user_profiles  │                           │
│  • tags        │   • ...            │                           │
│                │                    │                           │
└────────┬───────┴──────────┬─────────┴──────────┬────────────────┘
         │                  │                    │
         └──────────────────┼────────────────────┘
                            │
                            ▼
         ┌──────────────────────────────────────┐
         │        資料合併 & 映射               │
         │                                      │
         │  {                                   │
         │    recipient: { ... },               │
         │    order: { ... },                   │
         │    items: [ ... ]                    │
         │  }                                   │
         └──────────────────┬───────────────────┘
                            │
                            ▼
         ┌──────────────────────────────────────┐
         │          模板引擎處理                │
         │                                      │
         │  1. 變數替換                         │
         │     {{user.name}} → "張三"           │
         │                                      │
         │  2. 條件判斷                         │
         │     {{#if order.status == 'shipped'}}│
         │                                      │
         │  3. 迴圈處理                         │
         │     {{#each items}} ... {{/each}}    │
         │                                      │
         └──────────────────┬───────────────────┘
                            │
                            ▼
         ┌──────────────────────────────────────┐
         │         最終 JSON 訊息               │
         │                                      │
         │  {                                   │
         │    "type": "flex",                   │
         │    "contents": {                     │
         │      "body": {                       │
         │        "contents": [                 │
         │          { "text": "您好，張三！" }   │
         │        ]                             │
         │      }                               │
         │    }                                 │
         │  }                                   │
         └──────────────────┬───────────────────┘
                            │
                            ▼
         ┌──────────────────────────────────────┐
         │      LINE Messaging API              │
         │                                      │
         │  POST /v2/bot/message/push           │
         │  {                                   │
         │    "to": "U1234567890abcdef...",     │
         │    "messages": [ ... ]               │
         │  }                                   │
         └──────────────────────────────────────┘
```

### 系統整體資料流

```
┌──────────────┐
│   使用者      │
└──────┬───────┘
       │
       │ 1. 編輯模板
       ▼
┌──────────────────────┐
│   訊息編輯器 (前端)   │
│   - JSON 編輯        │
│   - 變數設定         │
│   - 即時預覽         │
└──────┬───────────────┘
       │
       │ 2. 儲存模板
       ▼
┌──────────────────────┐
│   後端 API           │
│   POST /api/templates│
└──────┬───────────────┘
       │
       │ 3. 寫入資料庫
       ▼
┌──────────────────────┐
│   Cloudflare D1      │
│   - message_templates│
│   - variable_configs │
└──────────────────────┘
       │
       │ 4. 推播觸發
       ▼
┌──────────────────────┐
│   推播服務 (後端)     │
│   - 取得模板         │
│   - 查詢資料         │
│   - 渲染訊息         │
└──────┬───────────────┘
       │
       │ 5. 發送訊息
       ▼
┌──────────────────────┐
│   LINE API           │
└──────┬───────────────┘
       │
       │ 6. 送達
       ▼
┌──────────────────────┐
│   LINE 使用者         │
└──────────────────────┘
```

---

## 時序圖

### 訊息推播完整時序

```
使用者      前端         後端          D1         LINE API     收件人
  │          │           │            │             │           │
  ├─ 點擊推播 ─>│           │            │             │           │
  │          │           │            │             │           │
  │          ├─ POST /broadcasts      │             │           │
  │          │────────>  │            │             │           │
  │          │           │            │             │           │
  │          │           ├─ 查詢模板   │             │           │
  │          │           │─────────>  │             │           │
  │          │           │<───────────│             │           │
  │          │           │            │             │           │
  │          │           ├─ 查詢收件人 │             │           │
  │          │           │─────────>  │             │           │
  │          │           │<───────────│             │           │
  │          │           │            │             │           │
  │          │           │ 逐個處理    │             │           │
  │          │           │            │             │           │
  │          │           ├─ 查詢資料   │             │           │
  │          │           │─────────>  │             │           │
  │          │           │<───────────│             │           │
  │          │           │            │             │           │
  │          │           ├─ 模板渲染   │             │           │
  │          │           │ (內部處理)  │             │           │
  │          │           │            │             │           │
  │          │           ├─ 推送訊息  ──────────────>│           │
  │          │           │            │             │           │
  │          │           │            │             ├─ 送達 ───>│
  │          │           │            │             │           │
  │          │           ├─ 記錄結果   │             │           │
  │          │           │─────────>  │             │           │
  │          │           │            │             │           │
  │          │<─ 回傳統計 ──────────│            │             │           │
  │          │           │            │             │           │
  │<─ 顯示結果 ──│           │            │             │           │
  │          │           │            │             │           │
```

---

## 技術架構圖

```
┌─────────────────────────────────────────────────────────────────┐
│                     瀏覽器 (Browser)                             │
│                                                                 │
│  ┌────────────────────────────────────────────────────────┐    │
│  │               Nuxt.js 應用程式                          │    │
│  │                                                        │    │
│  │  ┌──────────────┐  ┌──────────────┐  ┌─────────────┐ │    │
│  │  │   Pages      │  │  Components  │  │   Stores    │ │    │
│  │  │  - /editor   │  │  - JsonEditor│  │   (Pinia)   │ │    │
│  │  │  - /dashboard│  │  - Preview   │  │             │ │    │
│  │  │  - /schedules│  │  - QueryUI   │  │             │ │    │
│  │  └──────────────┘  └──────────────┘  └─────────────┘ │    │
│  │                                                        │    │
│  │  ┌────────────────────────────────────────────────┐   │    │
│  │  │           Composables & Utils                  │   │    │
│  │  │  - useAuth, useApi, useTemplate                │   │    │
│  │  └────────────────────────────────────────────────┘   │    │
│  └────────────────────────────────────────────────────────┘    │
│                                                                 │
└───────────────────────────┬─────────────────────────────────────┘
                            │
                            │ HTTPS
                            │
┌───────────────────────────┴─────────────────────────────────────┐
│              Cloudflare Workers (Edge Runtime)                  │
│                                                                 │
│  ┌────────────────────────────────────────────────────────┐    │
│  │                    Hono Framework                      │    │
│  │                                                        │    │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌───────┐ │    │
│  │  │  Routes  │  │  Services│  │Middleware│  │ Utils │ │    │
│  │  │          │  │          │  │          │  │       │ │    │
│  │  │ /auth    │  │ Template │  │   JWT    │  │Template│ │    │
│  │  │ /api/*   │  │ Engine   │  │   CORS   │  │Engine  │ │    │
│  │  │ /webhook │  │ Broadcast│  │   Auth   │  │Query   │ │    │
│  │  └──────────┘  └──────────┘  └──────────┘  └───────┘ │    │
│  └────────────────────────────────────────────────────────┘    │
│                                                                 │
│  ┌────────────────────────────────────────────────────────┐    │
│  │              Cron Triggers (排程)                      │    │
│  │              */5 * * * * (每5分鐘)                      │    │
│  └────────────────────────────────────────────────────────┘    │
│                                                                 │
└──────────┬─────────────────────────┬──────────────────────┬─────┘
           │                         │                      │
           ▼                         ▼                      ▼
┌─────────────────┐      ┌─────────────────┐    ┌──────────────────┐
│ Cloudflare D1   │      │  LINE           │    │ Cloudflare KV    │
│ (SQLite)        │      │  Messaging API  │    │ (Key-Value)      │
│                 │      │                 │    │                  │
│ - users         │      │ - Push Message  │    │ - Session Cache  │
│ - templates     │      │ - Multicast     │    │ - Rate Limiting  │
│ - broadcasts    │      │ - Reply         │    │                  │
│ - recipients    │      │                 │    │                  │
│ - schedules     │      │                 │    │                  │
└─────────────────┘      └─────────────────┘    └──────────────────┘
```

---

## 安全機制說明

### 多層防護策略

本系統採用「縱深防禦」(Defense in Depth) 策略，即使某一層被突破，其他層仍能提供保護。

```
請求 → [1. API 驗證] → [2. 權限檢查] → [3. SQL 驗證] → [4. 參數化查詢] → [5. 唯讀連線] → D1
        ↓                ↓               ↓               ↓                  ↓
      JWT Token        Role-Based      阻擋危險SQL     防注入            無寫入權限
      Rate Limit       Permissions     白名單機制      Prepared Stmt      Read-Only
```

### 實際執行流程範例

#### 使用者執行查詢的完整流程

```
1. 前端發送請求
   POST /api/query/execute
   Headers: { Authorization: "Bearer <JWT>" }
   Body: {
     sql: "SELECT * FROM orders WHERE status = ? LIMIT 100",
     params: ["shipped"]
   }

2. [安全檢查點 1] JWT 驗證
   ✓ Token 有效
   ✓ 使用者: alice@example.com
   ✓ Tenant ID: tenant_123
   ✓ Role: editor

3. [安全檢查點 2] Rate Limiting
   ✓ 檢查 KV: ratelimit:query:alice@example.com
   ✓ 當前: 45 次 / 60 分鐘
   ✓ 限制: 100 次 / 60 分鐘
   ✓ 通過

4. [安全檢查點 3] 權限檢查
   ✓ editor 角色可以執行查詢

5. [安全檢查點 4] SQL 驗證
   ✓ 只有 SELECT → 通過
   ✓ 沒有危險關鍵字 (DROP, DELETE) → 通過
   ✓ 有 LIMIT 子句 → 通過
   ✓ LIMIT 值 <= 10000 → 通過
   ✓ 沒有存取系統表 → 通過

6. [安全檢查點 5] 租戶隔離
   原始查詢:
   SELECT * FROM orders WHERE status = ? LIMIT 100

   自動改寫為:
   SELECT * FROM orders
   WHERE tenant_id = 'tenant_123' AND status = ?
   LIMIT 100

7. [安全檢查點 6] 參數化查詢
   const stmt = db.prepare(modifiedSql)
   const result = await stmt.bind('tenant_123', 'shipped').all()

8. [安全檢查點 7] 唯讀連線執行
   使用 DB_READONLY 連線
   即使 SQL 包含 UPDATE，也會被資料庫拒絕

9. 回傳結果給前端
   { success: true, data: [...], rowCount: 25 }

10. [審計] 記錄到 audit_log
    {
      user: "alice@example.com",
      action: "query.execute",
      sql: "SELECT * FROM orders...",
      status: "success",
      timestamp: "2024-01-15T10:30:00Z"
    }
```

### 如果遭遇攻擊

#### 場景：使用者嘗試 SQL 注入

```
惡意請求:
POST /api/query/execute
Body: {
  sql: "SELECT * FROM orders WHERE id = 1; DROP TABLE users; --",
  params: []
}

系統反應:
[安全檢查點 4] SQL 驗證器
❌ 偵測到多語句 (分號)
❌ 偵測到危險關鍵字: DROP

回應:
{
  "error": "Invalid SQL query",
  "message": "Multiple statements are not allowed"
}
狀態碼: 400

[審計日誌記錄]:
{
  user: "attacker@example.com",
  action: "query.execute",
  sql: "SELECT * FROM orders...",
  status: "blocked",
  reason: "dangerous_keyword_detected",
  ip: "123.45.67.89",
  timestamp: "..."
}

[警報觸發]:
→ 通知管理員可疑活動
→ 該使用者的 rate limit 降低
→ 如果短時間內多次嘗試，自動封鎖帳號
```

### 定期安全檢查清單

開發完成後，務必執行以下檢查：

- [ ] **SQL 注入測試**
  - 測試各種注入模式
  - 使用工具：sqlmap

- [ ] **權限繞過測試**
  - 嘗試以低權限角色執行高權限操作
  - 測試跨租戶存取

- [ ] **Rate Limiting 測試**
  - 短時間大量請求
  - 驗證是否正確限流

- [ ] **資料洩露測試**
  - 檢查錯誤訊息是否洩露敏感資訊
  - 檢查日誌是否包含敏感資料

- [ ] **API 安全測試**
  - CORS 設定
  - CSRF 防護
  - XSS 防護

---

## 總結

### 系統核心特色

1. **前後端分離**
   - 前端: Nuxt.js + Vue 3
   - 後端: Cloudflare Workers + Hono
   - 資料庫: Cloudflare D1

2. **模板系統創新**
   - JSON 貼上即用
   - 自動變數解析
   - 視覺化預覽
   - 多資料來源整合

3. **推播彈性**
   - 立即推播
   - 排程推播
   - 精準收件人選擇

4. **🔒 企業級安全**
   - 多層防護機制
   - SQL 注入防護
   - 租戶隔離
   - 審計日誌
   - 唯讀資料庫存取

5. **開發者友善**
   - RESTful API
   - TypeScript 全棧
   - 完整文檔

### 下一步

1. **最優先**：詳讀 [Story 10: 安全性與權限控制](stories/10-security-permissions.md)
2. 參考 [Stories README](stories/README.md) 了解完整開發規劃
3. 查看個別 Story 文檔了解詳細實作細節
4. 按照開發階段循序開發（先實作安全機制！）

### 重要提醒

⚠️ **在開發 D1 查詢功能之前，必須先完成 Story 10（安全性與權限控制）的所有驗收標準！**

沒有安全防護的查詢功能等同於開放資料庫給任何人存取，這是絕對不可接受的。

---

*最後更新: 2024-01-15*
